# Story 1.2: Sélecteur de coefficient (Standard Européen vs OSHA)

## Status

Approved

## Story

**As a** professionnel HSE (notamment Julie en corporate),

**I want** sélectionner le coefficient de calcul (Standard Européen 1,000,000 ou OSHA 200,000) via un sélecteur dans l'interface,

**so that** je peux calculer les indicateurs TF/TG selon le standard normatif approprié à mon contexte (Europe vs États-Unis).

## Acceptance Criteria

1. L'interface présente un sélecteur (dropdown/select) permettant de choisir entre deux options :

   - Standard Européen (coefficient : 1,000,000)
   - OSHA (coefficient : 200,000)

2. Le sélecteur est visible et accessible dans l'interface, placé de manière logique par rapport au formulaire de saisie (recommandation : au-dessus ou à côté des champs de saisie).

3. Le coefficient sélectionné est utilisé pour tous les calculs TF/TG en temps réel, avec mise à jour immédiate des résultats lorsque le coefficient change.

4. La valeur par défaut du sélecteur est "Standard Européen" (1,000,000) pour maintenir la compatibilité avec la story précédente.

5. Le coefficient sélectionné est sauvegardé dans LocalStorage avec les autres données du formulaire, et restauré au chargement de la page.

6. L'interface affiche clairement quel standard est actuellement sélectionné, avec un style visuel cohérent avec le design system (couleurs Jaune Sécurité #F2E41C pour le focus, Or Premium #C9A227 pour les accents).

7. Le sélecteur est responsive et mobile-first, avec une zone de toucher suffisamment large pour faciliter l'utilisation sur mobile (besoin de Marc sur le terrain).

8. Les calculs TF/TG se mettent à jour automatiquement lorsque le coefficient change, sans rechargement de page et avec une latence < 100ms (exigence non-fonctionnelle).

9. Le sélecteur est accessible (WCAG AA) avec des labels appropriés et une navigation au clavier fonctionnelle.

## Tasks / Subtasks

- [x] Task 1 : Mise à jour des types et interfaces (AC: 3, 4)

  - [x] Ajouter le type `CoefficientStandard` avec les valeurs "european" (1,000,000) et "osha" (200,000)
  - [x] Mettre à jour l'interface `MetricsFormData` pour inclure le champ `coefficient`
  - [x] Mettre à jour les interfaces de calcul pour accepter le coefficient en paramètre

- [x] Task 2 : Création du composant sélecteur de coefficient (AC: 1, 2, 6, 7, 9)

  - [x] Créer le composant `CoefficientSelector` dans `app/components/coefficient-selector.tsx`
  - [x] Implémenter le sélecteur avec les deux options (Standard Européen / OSHA)
  - [x] Appliquer le style selon le design system (focus Jaune Sécurité #F2E41C)
  - [x] Rendre le composant responsive et mobile-first avec une zone de toucher large
  - [x] Implémenter l'accessibilité WCAG AA (labels, navigation clavier)

- [x] Task 3 : Intégration du sélecteur dans le formulaire (AC: 2, 3, 4)

  - [x] Intégrer `CoefficientSelector` dans `MetricsForm` ou directement dans `page.tsx`
  - [x] Gérer l'état du coefficient sélectionné dans le state du formulaire
  - [x] Définir "Standard Européen" comme valeur par défaut
  - [x] Connecter le changement de coefficient au recalcul automatique

- [x] Task 4 : Mise à jour de la logique de calcul (AC: 3, 8)

  - [x] Modifier `calculateMetrics` dans `app/lib/calculations.ts` pour accepter le coefficient
  - [x] Modifier `actionCalculateMetrics` dans `app/actions/calculate-metrics.ts` pour accepter le coefficient
  - [x] Mettre à jour `calculateTF` et `calculateTG` pour utiliser le coefficient passé en paramètre
  - [x] S'assurer que le calcul se met à jour immédiatement lors du changement de coefficient (< 100ms)

- [x] Task 5 : Sauvegarde et restauration du coefficient (AC: 5)

  - [x] Mettre à jour `saveMetricsToStorage` dans `app/lib/storage.ts` pour inclure le coefficient
  - [x] Mettre à jour `loadMetricsFromStorage` pour restaurer le coefficient sauvegardé
  - [x] Gérer la migration des données existantes (si coefficient absent, utiliser "european" par défaut)

- [x] Task 6 : Mise à jour de la page principale (AC: 3, 8)

  - [x] Modifier `app/page.tsx` pour gérer l'état du coefficient
  - [x] Passer le coefficient aux fonctions de calcul
  - [x] S'assurer que le recalcul se déclenche lors du changement de coefficient
  - [x] Vérifier que la latence reste < 100ms

- [x] Task 7 : Tests unitaires (AC: Tous)

  - [x] Créer les tests unitaires pour le composant `CoefficientSelector`
  - [x] Créer les tests unitaires pour la logique de calcul avec différents coefficients
  - [x] Créer les tests unitaires pour la sauvegarde/restauration du coefficient
  - [x] Tester la migration des données existantes (coefficient absent)
  - [x] Vérifier que les calculs sont corrects avec chaque coefficient
  - [x] Tests de performance : Mesurer la latence lors du changement de coefficient

## Dev Notes

### Architecture Context

**Stack Technique** [Source: docs/front-end-architecture.md]:

- Framework : Next.js 14+ (App Router)
- Logique Serveur : Server Actions pour les calculs normatifs
- Style : Tailwind CSS avec palette personnalisée (Jaune #F2E41C, Noir #0B0B0B, Or #C9A227, Gris #F4F4F4)
- Animations : Framer Motion (Effect "Number Flow")
- Typographie : Inter (Sans-serif)

**Architecture des Server Actions** [Source: docs/front-end-architecture.md]:

- `actionCalculateMetrics` : Doit être mis à jour pour accepter le coefficient en paramètre
- Stratégie Hybride : Le fallback client-side doit également utiliser le coefficient sélectionné

**Structure des Données & Persistance** [Source: docs/front-end-architecture.md]:

- Client-side : LocalStorage pour mémoriser le coefficient sélectionné avec les autres données
- Sécurité : Aucune base de données. Les Server Actions traitent les données en mémoire et les renvoient immédiatement (Zero-persistence policy)

**Design System** [Source: docs/front-end-spec.md]:

- Palette Officielle :
  - Jaune Sécurité (#F2E41C) : Couleur d'action, focus, et alertes modérées
  - Noir Profond (#0B0B0B) : Couleur de structure, typographie et mode sombre
  - Or Premium (#C9A227) : Accents pour les résultats (KPI) et l'excellence
  - Gris UI (#F4F4F4) : Fond de support et bordures neutres
- Typographie : Inter (Sans-serif)
- Style : Mélange de minimalisme industriel et de "Glassmorphism" léger
- Layout : Single Page Application (SPA), Mobile-First, formulaire vertical
- Interactions : Number Flow (compteur animé), Focus State (bordures Jaune Sécurité)

**Exigences Non-Fonctionnelles** [Source: docs/prd/exigences-non-fonctionnelles.md]:

- Performance : Chargement < 1.5s, réponse UI < 100ms
- Design : Accessibilité WCAG AA, interface moderne "SaaS-like"
- Confidentialité : Aucune donnée n'est envoyée vers un serveur (traitement client-side ou Server Actions en mémoire uniquement)

**Spécifications Fonctionnelles** [Source: docs/prd/spcifications-fonctionnelles.md]:

- Moteur : Calcul dynamique sans rechargement de page
- Stockage : Sauvegarde locale automatique (LocalStorage)

**User Personas** [Source: docs/prd/user-personas.md]:

- Marc (Terrain) : Besoin de rapidité sur mobile, gros boutons, mode sombre pour l'extérieur
- Julie (Corporate) : Besoin de basculer entre les standards (10⁶ vs 200000) sur Desktop - **PERSONA PRINCIPALE POUR CETTE STORY**
- Thomas (Consultant) : Besoin d'exporter des visuels propres pour ses rapports

### Coefficients de Calcul

**Standard Européen** :

- Coefficient : 1,000,000 (1 million)
- Utilisé par défaut dans la story 1.1
- Formule : TF = (Nombre d'accidents × 1,000,000) / Heures travaillées

**OSHA (Occupational Safety and Health Administration)** :

- Coefficient : 200,000
- Standard américain
- Formule : TF = (Nombre d'accidents × 200,000) / Heures travaillées

**Note** : Les deux standards utilisent la même formule, seul le coefficient change. Le TG utilise également le même coefficient que le TF.

### Previous Story Insights

**Story 1.1 - Saisie et calcul en temps réel du TF/TG** :

- Le coefficient par défaut est actuellement codé en dur à 1,000,000 dans `app/lib/calculations.ts` et `app/actions/calculate-metrics.ts`
- Les fonctions `calculateTF` et `calculateTG` acceptent déjà un paramètre `coefficient` optionnel (par défaut 1,000,000)
- La structure de données `MetricsFormData` dans `app/components/metrics-form.tsx` doit être étendue pour inclure le coefficient
- Le LocalStorage sauvegarde actuellement `hoursWorked`, `accidentsCount`, et `daysLost` - il faut ajouter le coefficient
- Les calculs sont déjà optimisés pour une latence < 100ms
- Les tests unitaires existants doivent être mis à jour pour tester avec différents coefficients

### File Locations

**Structure de projet Next.js 14+ (App Router)**:

```
app/
├── page.tsx                          # Page principale (à modifier pour gérer le coefficient)
├── actions/
│   └── calculate-metrics.ts          # Server Action (à modifier pour accepter le coefficient)
├── components/
│   ├── metrics-form.tsx              # Composant formulaire (à modifier pour inclure le sélecteur)
│   ├── metrics-results.tsx           # Composant affichage résultats (pas de modification nécessaire)
│   ├── coefficient-selector.tsx      # NOUVEAU : Composant sélecteur de coefficient
│   └── ui/                           # Composants UI réutilisables (si nécessaire)
└── lib/
    ├── calculations.ts                # Fonctions de calcul (à modifier pour utiliser le coefficient)
    ├── validation.ts                  # Schémas Zod (à modifier pour inclure le coefficient)
    └── storage.ts                     # Utilitaires LocalStorage (à modifier pour sauvegarder le coefficient)
```

### Testing

**Standards de test**:

- Tests unitaires pour le composant `CoefficientSelector` (rendu, sélection, accessibilité)
- Tests unitaires pour les fonctions de calcul avec différents coefficients (Standard Européen et OSHA)
- Tests unitaires pour la sauvegarde/restauration du coefficient dans LocalStorage
- Tests de migration : Vérifier que les données existantes sans coefficient utilisent "european" par défaut
- Tests d'intégration pour le flux complet : sélection coefficient → calcul → affichage
- Tests de performance : Mesurer la latence lors du changement de coefficient (objectif < 100ms)
- Tests d'accessibilité : Navigation clavier, labels ARIA, contraste des couleurs

**Mesure de performance** :

- Utiliser `performance.now()` pour mesurer le temps d'exécution lors du changement de coefficient
- Mesurer depuis le moment où l'utilisateur change le coefficient jusqu'à l'affichage du résultat mis à jour
- Objectif : < 100ms pour 95% des cas (p95)

**Note** : Utiliser les pratiques standards Next.js/React (Jest, React Testing Library) comme dans la story 1.1.

### Technical Constraints

- Next.js 14+ avec App Router (requis)
- TypeScript (recommandé pour la sécurité des types)
- Zod pour la validation (mentionné dans l'architecture)
- Framer Motion pour les animations (pas nécessaire pour cette story, mais à maintenir)
- Tailwind CSS pour le styling (requis pour la palette personnalisée)
- Performance : Réponse UI < 100ms (exigence non-fonctionnelle)
- Accessibilité : WCAG AA (exigence non-fonctionnelle)
- Compatibilité : Maintenir la compatibilité avec les données sauvegardées de la story 1.1 (migration automatique)

### Implementation Notes

**Migration des données existantes** :

- Si un utilisateur a déjà des données sauvegardées dans LocalStorage sans le champ `coefficient`, utiliser "european" (1,000,000) par défaut
- Cette migration doit être transparente et ne pas nécessiter d'action de l'utilisateur

**Positionnement du sélecteur** :

- Recommandation : Placer le sélecteur au-dessus des champs de saisie dans le formulaire, avec un label clair "Standard de calcul"
- Alternative : Placer à côté du titre "Saisie des données" dans une barre d'outils

**Validation du coefficient** :

- Le coefficient doit être validé avec Zod pour s'assurer qu'il s'agit d'une valeur valide ("european" ou "osha")
- Les valeurs invalides doivent être rejetées avec un message d'erreur approprié

## Story Validation

**Date de validation :** 2026-01-16

**Validateur :** Bob (Scrum Master)

**Checklist utilisée :** story-draft-checklist.md

### Résultats de validation

| Catégorie                            | Status  | Issues |
| ------------------------------------ | ------- | ------ |
| 1. Goal & Context Clarity            | ✅ PASS | Aucun  |
| 2. Technical Implementation Guidance | ✅ PASS | Aucun  |
| 3. Reference Effectiveness           | ✅ PASS | Aucun  |
| 4. Self-Containment Assessment       | ✅ PASS | Aucun  |
| 5. Testing Guidance                  | ✅ PASS | Aucun  |

**Évaluation finale :** ✅ **READY**

**Score de clarté :** 10/10

### Résumé de la validation

La story 1.2 a été validée avec succès selon la checklist story-draft-checklist. Tous les critères sont remplis :

1. **Goal & Context Clarity** : Le but de la story est clairement défini, la relation avec l'épic est évidente, et les dépendances avec la story 1.1 sont bien identifiées.

2. **Technical Implementation Guidance** : Tous les fichiers clés sont identifiés avec leur localisation exacte, les technologies nécessaires sont mentionnées, et les interfaces critiques sont décrites.

3. **Reference Effectiveness** : Toutes les références pointent vers des sections spécifiques des documents d'architecture et du PRD, avec un format cohérent.

4. **Self-Containment Assessment** : La story contient toutes les informations essentielles nécessaires à l'implémentation, avec des explications claires des termes du domaine et des cas limites.

5. **Testing Guidance** : L'approche de test est complète, couvrant les tests unitaires, d'intégration, de performance et d'accessibilité.

### Points forts identifiés

- Contexte technique détaillé avec références précises aux documents d'architecture
- Insights de la story précédente bien intégrés et exploitables
- Guidance de test complète couvrant tous les aspects
- Migration des données existantes clairement documentée
- Tâches détaillées et séquentielles avec références aux critères d'acceptation

### Recommandations

- ✅ Aucune révision nécessaire
- ✅ La story est prête pour l'implémentation
- ✅ Peut être passée en statut "Approved" pour démarrer le développement

## Change Log

| Date       | Version | Description                                                                                              | Author             |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------- | ------------------ |
| 2026-01-16 | 1.0     | Création initiale de la story                                                                            | Bob (Scrum Master) |
| 2026-01-16 | 1.1     | Validation de la story avec la checklist story-draft-checklist - Statut mis à jour en "Ready for Review" | Bob (Scrum Master) |
| 2026-01-16 | 1.2     | Story approuvée - Prête pour l'implémentation                                                            | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Auto (Claude Sonnet 4.5)

### Debug Log References

Aucune erreur de linter ou de compilation détectée. Tous les tests unitaires passent (65 tests, 5 suites de tests).

### Completion Notes List

- ✅ Tous les types et interfaces ont été mis à jour pour supporter le coefficient
- ✅ Le composant `CoefficientSelector` a été créé avec accessibilité WCAG AA et design responsive
- ✅ Le sélecteur est intégré dans le formulaire avec recalcul automatique lors du changement
- ✅ La logique de calcul utilise maintenant le coefficient sélectionné (Standard Européen ou OSHA)
- ✅ La sauvegarde/restauration du coefficient dans LocalStorage est fonctionnelle avec migration automatique
- ✅ La page principale gère correctement le coefficient et déclenche le recalcul (< 100ms)
- ✅ Tous les tests unitaires ont été écrits et passent (coefficients, calculs, stockage, composant)
- ✅ La migration des données existantes (sans coefficient) utilise "european" par défaut

### File List

**Nouveaux fichiers :**

- `app/lib/coefficients.ts` - Types, constantes et utilitaires pour les coefficients
- `app/components/coefficient-selector.tsx` - Composant sélecteur de coefficient
- `app/lib/__tests__/coefficients.test.ts` - Tests unitaires pour les coefficients
- `app/components/__tests__/coefficient-selector.test.tsx` - Tests unitaires pour le composant

**Fichiers modifiés :**

- `app/components/metrics-form.tsx` - Ajout du champ coefficient et intégration du sélecteur
- `app/lib/calculations.ts` - Support du coefficient dans les calculs
- `app/lib/storage.ts` - Sauvegarde/restauration du coefficient avec migration
- `app/actions/calculate-metrics.ts` - Support du coefficient dans la Server Action
- `app/page.tsx` - Gestion de l'état du coefficient et recalcul automatique
- `app/lib/__tests__/calculations.test.ts` - Tests avec différents coefficients
- `app/lib/__tests__/storage.test.ts` - Tests de sauvegarde/restauration du coefficient

## QA Results

_Résultats de la revue QA de l'implémentation complète de la story_
