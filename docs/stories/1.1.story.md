# Story 1.1: Saisie et calcul en temps réel du TF/TG

## Status

Ready for Review

## Story

**As a** professionnel HSE (Marc sur le terrain, Julie en corporate, ou Thomas consultant),

**I want** saisir les données (heures travaillées, nombre d'accidents, jours perdus) et voir le calcul du Taux de Fréquence (TF) et du Taux de Gravité (TG) se mettre à jour en temps réel,

**so that** je peux obtenir instantanément les indicateurs de sécurité sans recharger la page ni attendre un traitement serveur.

## Acceptance Criteria

1. L'interface présente un formulaire avec trois champs de saisie :

   - Heures travaillées (nombre entier positif)
   - Nombre d'accidents (nombre entier positif ou zéro)
   - Jours perdus (nombre entier positif ou zéro)

2. Les calculs TF et TG se mettent à jour automatiquement à chaque modification d'un champ, sans rechargement de page et avec une latence < 100ms (exigence non-fonctionnelle).

3. Les formules de calcul sont correctes selon les standards normatifs :

   - TF = (Nombre d'accidents × Coefficient) / Heures travaillées
   - TG = (Jours perdus × Coefficient) / Heures travaillées
   - Coefficient par défaut : 1,000,000 (Standard Européen) - le sélecteur de coefficient sera dans une story ultérieure (US.2)

4. Les résultats sont affichés avec une animation "Number Flow" (Framer Motion) pour un effet visuel fluide lors du changement de valeur.

5. Les champs de saisie ont des états de focus visibles (bordure Jaune Sécurité #F2E41C) selon le design system.

6. La validation des entrées empêche la saisie de valeurs négatives ou invalides.

7. Les données saisies sont automatiquement sauvegardées dans LocalStorage pour permettre la récupération lors d'un retour sur la page (spécification fonctionnelle).

8. L'interface est responsive et mobile-first avec de larges zones de saisie pour faciliter l'utilisation sur le terrain (besoin de Marc).

9. La validation des entrées inclut des limites maximales raisonnables :

   - Heures travaillées : maximum 10,000,000 (10 millions d'heures)
   - Nombre d'accidents : maximum 1,000,000 (1 million)
   - Jours perdus : maximum 1,000,000 (1 million)

10. Les cas limites de calcul sont gérés correctement :
    - Division par zéro : Si heures travaillées = 0, afficher un message d'erreur approprié au lieu de calculer
    - Overflow numérique : Gérer les cas où le résultat dépasse les limites JavaScript (utiliser BigInt si nécessaire)
    - Valeurs nulles : Si un champ est vide, ne pas effectuer de calcul ou afficher "N/A"

## Tasks / Subtasks

- [x] Task 1 : Configuration du projet Next.js 14+ avec App Router (AC: Tous)

  - [x] Initialiser le projet Next.js 14+ avec TypeScript
  - [x] Configurer Tailwind CSS avec la palette personnalisée (Jaune #F2E41C, Noir #0B0B0B, Or #C9A227, Gris #F4F4F4)
  - [x] Configurer la typographie Inter (Sans-serif)
  - [x] Configurer Framer Motion pour les animations

- [x] Task 2 : Création de la structure de base de l'interface (AC: 1, 5, 8)

  - [x] Créer le layout principal (Single Page Application, pas de rechargement)
  - [x] Créer le composant de formulaire avec les trois champs de saisie
  - [x] Appliquer le style mobile-first avec de larges zones de saisie
  - [x] Implémenter les états de focus avec bordure Jaune Sécurité #F2E41C

- [x] Task 3 : Implémentation de la logique de calcul (AC: 2, 3, 10)

  - [x] Créer la fonction de calcul TF avec validation Zod
  - [x] Créer la fonction de calcul TG avec validation Zod
  - [x] Implémenter le calcul en temps réel (mise à jour à chaque changement de champ)
  - [x] Gérer le cas de division par zéro (heures travaillées = 0) : retourner une erreur ou null avec message approprié
  - [x] Gérer les cas d'overflow numérique : utiliser BigInt si nécessaire pour les très grandes valeurs
  - [x] Gérer les valeurs nulles/vides : ne pas calculer si un champ requis est vide
  - [x] Vérifier que la latence de réponse UI est < 100ms

- [x] Task 4 : Création du Server Action pour les calculs (AC: 2, 3)

  - [x] Créer `actionCalculateMetrics` dans `app/actions/calculate-metrics.ts`
  - [x] Implémenter la validation des entrées avec Zod
  - [x] Retourner les résultats TF/TG
  - [x] Implémenter le fallback client-side pour le mode offline (stratégie hybride)

- [x] Task 5 : Affichage des résultats avec animation (AC: 4)

  - [x] Créer le composant d'affichage des résultats TF/TG
  - [x] Intégrer Framer Motion avec l'effet "Number Flow" pour l'animation des chiffres
  - [x] Appliquer le style avec la couleur Or Premium (#C9A227) pour les KPI selon le design system

- [x] Task 6 : Validation des entrées (AC: 6, 9)

  - [x] Implémenter la validation côté client pour empêcher les valeurs négatives
  - [x] Définir et appliquer les limites maximales :
    - Heures travaillées : max 10,000,000
    - Nombre d'accidents : max 1,000,000
    - Jours perdus : max 1,000,000
  - [x] Ajouter des messages d'erreur appropriés pour chaque cas de validation
  - [x] S'assurer que seuls les nombres entiers positifs ou zéro sont acceptés
  - [x] Valider que les valeurs ne dépassent pas les limites maximales définies

- [x] Task 7 : Sauvegarde automatique dans LocalStorage (AC: 7)

  - [x] Implémenter la sauvegarde automatique des données saisies dans LocalStorage
  - [x] Implémenter la restauration des données au chargement de la page
  - [x] Gérer les cas d'erreur (LocalStorage indisponible, quota dépassé)

- [x] Task 8 : Tests unitaires (AC: Tous)
  - [x] Créer les tests unitaires pour les fonctions de calcul TF/TG
  - [x] Créer les tests unitaires pour la validation Zod
  - [x] Créer les tests unitaires pour la sauvegarde LocalStorage
  - [x] Vérifier la précision des calculs selon les standards normatifs
  - [x] Tester les cas limites : division par zéro, valeurs maximales, overflow
  - [x] Tests de performance : Mesurer la latence de calcul en utilisant `performance.now()` ou `Date.now()` pour s'assurer que le temps de réponse est < 100ms même avec des valeurs importantes
  - [x] Créer des tests de charge pour valider les performances avec des calculs répétés

## Dev Notes

### Architecture Context

**Stack Technique** [Source: docs/front-end-architecture/stack-technique.md]:

- Framework : Next.js 14+ (App Router)
- Logique Serveur : Server Actions pour les calculs normatifs
- Style : Tailwind CSS avec palette personnalisée (Jaune #F2E41C, Noir #0B0B0B, Or #C9A227, Gris #F4F4F4)
- Animations : Framer Motion (Effect "Number Flow")
- Typographie : Inter (Sans-serif)

**Architecture des Server Actions** [Source: docs/front-end-architecture/architecture-des-server-actions.md]:

- `actionCalculateMetrics` : Valide les entrées avec Zod et retourne les TF/TG
- Stratégie Hybride : Utilisation d'un fallback client-side en cas d'absence de réseau pour garantir le fonctionnement PWA

**Structure des Données & Persistance** [Source: docs/front-end-architecture/structure-des-donnes-persistance.md]:

- Client-side : LocalStorage pour mémoriser les dernières saisies
- Sécurité : Aucune base de données. Les Server Actions traitent les données en mémoire et les renvoient immédiatement (Zero-persistence policy)

**Design System** [Source: docs/front-end-spec.md]:

- Palette Officielle :
  - Jaune Sécurité (#F2E41C) : Couleur d'action, focus, et alertes modérées
  - Noir Profond (#0B0B0B) : Couleur de structure, typographie et mode sombre
  - Or Premium (#C9A227) : Accents pour les résultats (KPI) et l'excellence
  - Gris UI (#F4F4F4) : Fond de support et bordures neutres
- Typographie : Inter (Sans-serif)
- Style : Mélange de minimalisme industriel et de "Glassmorphism" léger
- Layout : Single Page Application (SPA), Mobile-First, formulaire vertical
- Interactions : Number Flow (compteur animé), Focus State (bordures Jaune Sécurité)

**Exigences Non-Fonctionnelles** [Source: docs/prd/exigences-non-fonctionnelles.md]:

- Performance : Chargement < 1.5s, réponse UI < 100ms
- Design : Accessibilité WCAG AA, interface moderne "SaaS-like"
- Confidentialité : Aucune donnée n'est envoyée vers un serveur (traitement client-side ou Server Actions en mémoire uniquement)

**Spécifications Fonctionnelles** [Source: docs/prd/spcifications-fonctionnelles.md]:

- Moteur : Calcul dynamique sans rechargement de page
- Stockage : Sauvegarde locale automatique (LocalStorage)
- Offline : Service Workers pour la mise en cache des ressources (sera implémenté dans US.3)

**User Personas** [Source: docs/prd/user-personas.md]:

- Marc (Terrain) : Besoin de rapidité sur mobile, gros boutons, mode sombre pour l'extérieur
- Julie (Corporate) : Besoin de basculer entre les standards (10⁶ vs 200000) sur Desktop
- Thomas (Consultant) : Besoin d'exporter des visuels propres pour ses rapports

### Formules de Calcul

**Taux de Fréquence (TF)**:

```
TF = (Nombre d'accidents × Coefficient) / Heures travaillées
```

**Taux de Gravité (TG)**:

```
TG = (Jours perdus × Coefficient) / Heures travaillées
```

**Coefficient par défaut** : 1,000,000 (Standard Européen)

- Note : Le sélecteur de coefficient (Standard Européen 1,000,000 vs OSHA 200,000) sera implémenté dans la story suivante (US.2)

### Cas Limites et Gestion d'Erreurs

**Division par zéro** :

- Si heures travaillées = 0, le calcul ne peut pas être effectué
- Comportement attendu : Afficher un message d'erreur clair (ex: "Les heures travaillées doivent être supérieures à 0 pour calculer les indicateurs")
- Ne pas afficher de résultats TF/TG dans ce cas

**Valeurs maximales** :

- Heures travaillées : Maximum 10,000,000 (limite raisonnable pour éviter les problèmes de performance et d'overflow)
- Nombre d'accidents : Maximum 1,000,000
- Jours perdus : Maximum 1,000,000
- Au-delà de ces limites, afficher un message d'erreur de validation

**Overflow numérique** :

- JavaScript Number peut représenter des entiers jusqu'à 2^53 - 1 (Number.MAX_SAFE_INTEGER = 9,007,199,254,740,991)
- Pour les calculs avec de très grandes valeurs, considérer l'utilisation de BigInt si nécessaire
- Tester avec des valeurs proches des limites pour s'assurer de la précision

**Valeurs nulles/vides** :

- Si un champ est vide, ne pas effectuer de calcul
- Afficher "N/A" ou un état par défaut pour les résultats TF/TG
- Permettre la saisie progressive (calculer dès qu'au moins les heures travaillées sont renseignées)

### File Locations

**Structure de projet Next.js 14+ (App Router)**:

```
app/
├── page.tsx                    # Page principale (formulaire + résultats)
├── actions/
│   └── calculate-metrics.ts    # Server Action pour les calculs
├── components/
│   ├── metrics-form.tsx        # Composant formulaire de saisie
│   ├── metrics-results.tsx     # Composant affichage résultats avec animation
│   └── ui/                     # Composants UI réutilisables (si nécessaire)
└── lib/
    ├── calculations.ts         # Fonctions de calcul client-side (fallback)
    ├── validation.ts           # Schémas Zod pour validation
    └── storage.ts              # Utilitaires LocalStorage
```

### Testing

**Standards de test**:

- Tests unitaires pour les fonctions de calcul (précision des formules)
- Tests unitaires pour la validation Zod
- Tests unitaires pour la sauvegarde/restauration LocalStorage
- Tests d'intégration pour le flux complet de saisie → calcul → affichage
- Tests des cas limites : division par zéro, valeurs maximales, overflow, valeurs nulles
- Vérification de la performance (latence < 100ms)

**Mesure de performance** :

- Utiliser `performance.now()` pour mesurer le temps d'exécution des calculs
- Mesurer depuis le moment où l'utilisateur modifie un champ jusqu'à l'affichage du résultat
- Objectif : < 100ms pour 95% des cas (p95)
- Créer des tests de performance automatisés avec des valeurs typiques et extrêmes
- Utiliser React Profiler ou Chrome DevTools Performance pour analyser les performances en développement

**Note** : Aucun document de stratégie de test spécifique trouvé dans l'architecture. Utiliser les pratiques standards Next.js/React (Jest, React Testing Library).

### Technical Constraints

- Next.js 14+ avec App Router (requis)
- TypeScript (recommandé pour la sécurité des types)
- Zod pour la validation (mentionné dans l'architecture)
- Framer Motion pour les animations (requis pour l'effet Number Flow)
- Tailwind CSS pour le styling (requis pour la palette personnalisée)
- Performance : Réponse UI < 100ms (exigence non-fonctionnelle)
- Accessibilité : WCAG AA (exigence non-fonctionnelle)

### Previous Story Insights

Aucune story précédente (première story du projet).

## Change Log

| Date       | Version | Description                                                                                                           | Author             |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------- | ------------------ |
| 2026-01-16 | 1.0     | Création initiale de la story                                                                                         | Bob (Scrum Master) |
| 2026-01-16 | 1.1     | Ajout des cas limites (division par zéro, overflow), limites de validation, et spécifications de tests de performance | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Agent)

### Debug Log References

Aucune erreur critique rencontrée pendant le développement. Les tests passent tous avec succès (43 tests passés).

### Completion Notes List

- Projet Next.js 14+ configuré avec TypeScript, Tailwind CSS, et Framer Motion
- Tous les composants créés selon les spécifications (formulaire, résultats, animations)
- Calculs TF/TG implémentés avec validation Zod complète
- Server Action créé avec fallback client-side pour mode offline
- LocalStorage implémenté pour sauvegarde automatique
- Tests unitaires complets couvrant tous les cas (calculs, validation, stockage, performance)
- Performance validée : latence < 100ms confirmée par les tests
- Tous les critères d'acceptation respectés

### File List

**Configuration:**

- `package.json` - Configuration du projet et dépendances
- `tsconfig.json` - Configuration TypeScript
- `tailwind.config.ts` - Configuration Tailwind avec palette personnalisée
- `postcss.config.mjs` - Configuration PostCSS
- `next.config.mjs` - Configuration Next.js
- `jest.config.js` - Configuration Jest pour les tests
- `jest.setup.js` - Configuration de setup Jest
- `.eslintrc.json` - Configuration ESLint
- `.gitignore` - Fichiers ignorés par Git
- `next-env.d.ts` - Types TypeScript Next.js

**Application:**

- `app/layout.tsx` - Layout principal avec métadonnées
- `app/page.tsx` - Page principale avec logique de calcul en temps réel
- `app/globals.css` - Styles globaux avec typographie Inter

**Composants:**

- `app/components/metrics-form.tsx` - Composant formulaire de saisie
- `app/components/metrics-results.tsx` - Composant affichage résultats avec animation

**Logique métier:**

- `app/lib/calculations.ts` - Fonctions de calcul TF/TG
- `app/lib/validation.ts` - Schémas Zod de validation
- `app/lib/storage.ts` - Utilitaires LocalStorage

**Server Actions:**

- `app/actions/calculate-metrics.ts` - Server Action pour calculs normatifs

**Tests:**

- `app/lib/__tests__/calculations.test.ts` - Tests unitaires calculs
- `app/lib/__tests__/validation.test.ts` - Tests unitaires validation
- `app/lib/__tests__/storage.test.ts` - Tests unitaires LocalStorage

## QA Results

_Résultats de la revue QA de l'implémentation complète de la story_
